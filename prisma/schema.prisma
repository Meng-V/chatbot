generator client {
  provider        = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Message {
  id              String       @id @default(uuid())
  type            String       @db.VarChar(10)
  content         String
  timestamp       DateTime     @default(now())
  conversationId  String
  isPositiveRated Boolean?
  conversation    Conversation @relation(fields: [conversationId], references: [id])
}

model Conversation {
  id                   String                @id @default(uuid())
  toolUsed             String[]              @default([])
  conversationFeedback ConversationFeedback?
  messageList          Message[]
  tokenUsages          ModelTokenUsage[]
  toolExecutions       ToolExecution[]
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
}

model ModelTokenUsage {
  id               String       @id @default(uuid())
  llmModelName     String
  completionTokens Int
  promptTokens     Int
  totalTokens      Int
  conversationId   String
  conversation     Conversation @relation(fields: [conversationId], references: [id])
  createdAt        DateTime     @default(now())
}

model ToolExecution {
  id              String       @id @default(uuid())
  conversationId  String
  agentName       String
  toolName        String
  parameters      String       @default("{}")
  success         Boolean
  executionTime   Int          @default(0)
  timestamp       DateTime     @default(now())
  conversation    Conversation @relation(fields: [conversationId], references: [id])
  
  @@index([conversationId])
  @@index([agentName])
  @@index([toolName])
}

model ConversationFeedback {
  id             String       @id @default(uuid())
  rating         Int
  userComment    String
  conversationId String       @unique
  conversation   Conversation @relation(fields: [conversationId], references: [id])
}

// MuGuide Subject Mapping Models
model Subject {
  id          String             @id @default(uuid())
  name        String             @unique
  regional    Boolean            @default(false)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  libGuides   SubjectLibGuide[]
  regCodes    SubjectRegCode[]
  majorCodes  SubjectMajorCode[]
  deptCodes   SubjectDeptCode[]

  @@index([name])
}

model SubjectLibGuide {
  id        String  @id @default(uuid())
  subjectId String
  libGuide  String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([subjectId, libGuide])
  @@index([libGuide])
}

model SubjectRegCode {
  id        String  @id @default(uuid())
  subjectId String
  regCode   String
  regName   String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([subjectId, regCode])
  @@index([regCode])
}

model SubjectMajorCode {
  id         String  @id @default(uuid())
  subjectId  String
  majorCode  String
  majorName  String
  subject    Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([subjectId, majorCode])
  @@index([majorCode])
  @@index([majorName])
}

model SubjectDeptCode {
  id        String  @id @default(uuid())
  subjectId String
  deptCode  String
  deptName  String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([subjectId, deptCode])
  @@index([deptCode])
  @@index([deptName])
}
