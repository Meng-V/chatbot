# Fact Grounding System - Architecture Diagram

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          USER INTERFACE                                â”‚
â”‚                  "When was King Library built?"                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     HYBRID ROUTER                                      â”‚
â”‚  â€¢ Determines if query is simple or complex                            â”‚
â”‚  â€¢ Routes to Function Calling or LangGraph                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    META ROUTER (LangGraph)                             â”‚
â”‚  â€¢ Classifies intent (discovery, policy, booking, etc.)                â”‚
â”‚  â€¢ Routes to appropriate agents                                        â”‚
â”‚  â€¢ For factual queries â†’ Includes transcript_rag agent                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AGENT EXECUTION LAYER                               â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Primo Agent  â”‚  â”‚ LibCal Agent â”‚  â”‚  RAG Agent   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                              â”‚                         â”‚
â”‚                                              â–¼                         â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚                                    â”‚  WEAVIATE DB     â”‚                â”‚
â”‚                                    â”‚  TranscriptQA    â”‚                â”‚
â”‚                                    â”‚  Collection      â”‚                â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  SYNTHESIS NODE (WITH FACT GROUNDING)                  â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  LAYER 1: FACT TYPE DETECTION                                    â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                    â”‚ â”‚
â”‚  â”‚  â€¢ Pattern matching on user query                                â”‚ â”‚
â”‚  â”‚  â€¢ Detects: dates, locations, people, quantities, policies       â”‚ â”‚
â”‚  â”‚  â€¢ Triggers: strict_grounding_mode = True                        â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚  def detect_factual_query_type(query: str) -> List[str]:        â”‚ â”‚
â”‚  â”‚      patterns = {                                                â”‚ â”‚
â”‚  â”‚          "date": [r"\b(when|year|built)\b", ...],               â”‚ â”‚
â”‚  â”‚          "location": [r"\b(where|located)\b", ...],             â”‚ â”‚
â”‚  â”‚          ...                                                     â”‚ â”‚
â”‚  â”‚      }                                                           â”‚ â”‚
â”‚  â”‚      return detected_types                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  LAYER 2: STRICT GROUNDING MODE                                  â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚ â”‚
â”‚  â”‚  IF factual query detected AND RAG has data:                     â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚  1. Check RAG confidence:                                        â”‚ â”‚
â”‚  â”‚     â€¢ similarity >= 0.85 â†’ HIGH confidence                       â”‚ â”‚
â”‚  â”‚     â€¢ similarity >= 0.75 â†’ MEDIUM confidence                     â”‚ â”‚
â”‚  â”‚     â€¢ similarity < 0.70  â†’ ESCALATE to human                     â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚  2. Use enhanced grounding prompt:                               â”‚ â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚ â”‚
â”‚  â”‚     â”‚ CRITICAL GROUNDING RULES:                      â”‚           â”‚ â”‚
â”‚  â”‚     â”‚ 1. ONLY use dates from RAG context             â”‚           â”‚ â”‚
â”‚  â”‚     â”‚ 2. NEVER use LLM training data                 â”‚           â”‚ â”‚
â”‚  â”‚     â”‚ 3. If info missing â†’ say "don't have info"     â”‚           â”‚ â”‚
â”‚  â”‚     â”‚ 4. Cite source when possible                   â”‚           â”‚ â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚  3. Generate response using ONLY RAG context                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  LAYER 3: FACT VERIFICATION                                      â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                      â”‚ â”‚
â”‚  â”‚  After LLM generates response:                                   â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚  1. Extract factual claims:                                      â”‚ â”‚
â”‚  â”‚     â€¢ Years: regex r'\b(19\d{2}|20\d{2})\b'                     â”‚ â”‚
â”‚  â”‚     â€¢ Locations: "King Library", "Room 101", etc.               â”‚ â”‚
â”‚  â”‚     â€¢ People: capitalized names                                  â”‚ â”‚
â”‚  â”‚     â€¢ Contact info: emails, phones, URLs                         â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚  2. Verify against RAG context:                                  â”‚ â”‚
â”‚  â”‚     FOR each claim:                                              â”‚ â”‚
â”‚  â”‚         IF claim NOT in RAG context:                             â”‚ â”‚
â”‚  â”‚             â†’ Log warning                                        â”‚ â”‚
â”‚  â”‚             â†’ Mark as unverified                                 â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚  3. Add disclaimer if needed:                                    â”‚ â”‚
â”‚  â”‚     IF unverified claims found:                                  â”‚ â”‚
â”‚  â”‚         response += "Please contact librarian to verify..."      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      URL VALIDATION                                    â”‚
â”‚  â€¢ Validates all URLs in response                                     â”‚
â”‚  â€¢ Removes invalid/hallucinated URLs                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FINAL RESPONSE                                    â”‚
â”‚  "King Library was built in 1972."                                    â”‚
â”‚  [Grounded âœ…] [Verified âœ…] [URLs validated âœ…]                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Decision Flow for Factual Queries

```
User Query
    â”‚
    â–¼
Is it a factual query?
(Check FACTUAL_PATTERNS)
    â”‚
    â”œâ”€â”€â”€ NO â”€â”€â†’ Use standard synthesis prompt
    â”‚
    â””â”€â”€â”€ YES â”€â”€â†’ Does RAG have data?
                     â”‚
                     â”œâ”€â”€â”€ NO â”€â”€â†’ Use standard prompt
                     â”‚
                     â””â”€â”€â”€ YES â”€â”€â†’ Check RAG confidence
                                      â”‚
                                      â”œâ”€â”€â”€ < 0.70 â”€â”€â†’ Escalate to human
                                      â”‚                "Contact librarian at..."
                                      â”‚
                                      â”œâ”€â”€â”€ 0.70-0.79 â”€â”€â†’ Use strict grounding
                                      â”‚                   + Add verification
                                      â”‚
                                      â””â”€â”€â”€ >= 0.80 â”€â”€â†’ Use strict grounding
                                                       + High confidence
                                                       + Verify facts
                                                       
                                      â†“
                            Generate response with LLM
                            (using grounded prompt)
                                      â†“
                            Extract factual claims
                                      â†“
                            Verify against RAG context
                                      â†“
                            â”Œâ”€â”€â”€ All verified â”€â”€â†’ Return response âœ…
                            â”‚
                            â””â”€â”€â”€ Some unverified â”€â”€â†’ Add disclaimer
                                                     Return response âš ï¸
```

---

## Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      RAG DATABASE UPDATE                        â”‚
â”‚                                                                 â”‚
â”‚  Librarian/Admin                                                â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚  edit update_rag_facts.py                                       â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚  CORRECT_FACTS = [                                              â”‚
â”‚      {                                                          â”‚
â”‚          "question": "When was King Library built?",            â”‚
â”‚          "answer": "King Library was built in 1972.",           â”‚
â”‚          "keywords": ["King Library", "1972", "built"]          â”‚
â”‚      }                                                          â”‚
â”‚  ]                                                              â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚  python update_rag_facts.py                                     â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚   WEAVIATE CLOUD    â”‚                                        â”‚
â”‚  â”‚                     â”‚                                        â”‚
â”‚  â”‚  TranscriptQA       â”‚                                        â”‚
â”‚  â”‚  Collection:        â”‚                                        â”‚
â”‚  â”‚  â€¢ question (text)  â”‚                                        â”‚
â”‚  â”‚  â€¢ answer (text)    â”‚                                        â”‚
â”‚  â”‚  â€¢ topic (text)     â”‚                                        â”‚
â”‚  â”‚  â€¢ keywords (list)  â”‚                                        â”‚
â”‚  â”‚  â€¢ vector (768-dim) â”‚ â† OpenAI embedding                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚       â”‚                                                         â”‚
â”‚       â””â”€â†’ Used by RAG Agent at query time                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      QUERY TIME FLOW                            â”‚
â”‚                                                                 â”‚
â”‚  User Query: "When was King Library built?"                     â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚  fact_types = detect_factual_query_type(query)                  â”‚
â”‚  # Returns: ["date"]                                            â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚  rag_result = await transcript_rag_query(query)                 â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â†’ Weaviate: near_text search with OpenAI embedding      â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â†’ Returns top 5 matches with similarity scores          â”‚
â”‚       â”‚                                                         â”‚
â”‚       â””â”€â†’ rag_result = {                                        â”‚
â”‚               "text": "King Library was built in 1972.",        â”‚
â”‚               "confidence": "high",                             â”‚
â”‚               "similarity_score": 0.92,                         â”‚
â”‚               "matched_topic": "building_information"           â”‚
â”‚           }                                                     â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚  is_confident, reason = is_high_confidence_rag_match(rag_result)â”‚
â”‚  # Returns: (True, "High confidence match (similarity: 0.92)")  â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚  grounded_prompt = create_grounded_synthesis_prompt(            â”‚
â”‚      user_message=query,                                        â”‚
â”‚      rag_response=rag_result,                                   â”‚
â”‚      fact_types=fact_types                                      â”‚
â”‚  )                                                              â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚  response = await llm.ainvoke([                                 â”‚
â”‚      SystemMessage("Use ONLY RAG context..."),                  â”‚
â”‚      HumanMessage(grounded_prompt)                              â”‚
â”‚  ])                                                             â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚  all_verified, issues = verify_factual_claims_against_rag(      â”‚
â”‚      generated_text=response,                                   â”‚
â”‚      rag_context=rag_result["text"]                             â”‚
â”‚  )                                                              â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â”€â”€ All verified â”€â”€â†’ Return response âœ…                  â”‚
â”‚       â”‚                                                         â”‚
â”‚       â””â”€â”€â”€ Issues found â”€â”€â†’ Add disclaimer                      â”‚
â”‚                             Return response + warning âš ï¸        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Interaction

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FACTUAL QUERY COMPONENTS                                      â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚ FACTUAL_PATTERNS     â”‚                                      â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚                                      â”‚
â”‚  â”‚ â€¢ date: [patterns]   â”‚                                      â”‚
â”‚  â”‚ â€¢ location: [...]    â”‚â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ â€¢ person: [...]      â”‚    â”‚                                 â”‚
â”‚  â”‚ â€¢ quantity: [...]    â”‚    â”‚                                 â”‚
â”‚  â”‚ â€¢ policy: [...]      â”‚    â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                                 â”‚
â”‚                              â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ detect_factual_      â”‚â—„â”€â”€â”€â”´â”€â”€â”€â–ºâ”‚ should_enforce_strict_  â”‚ â”‚
â”‚  â”‚ query_type()         â”‚          â”‚ grounding()             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â”‚                                    â”‚               â”‚
â”‚            â”‚                                    â”‚               â”‚
â”‚            â–¼                                    â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ create_grounded_synthesis_prompt()                       â”‚  â”‚
â”‚  â”‚ â€¢ Includes GROUNDED_SYNTHESIS_INSTRUCTIONS               â”‚  â”‚
â”‚  â”‚ â€¢ Forces LLM to use ONLY RAG context                     â”‚  â”‚
â”‚  â”‚ â€¢ Prohibits hallucination                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                                                    â”‚
â”‚            â–¼                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ LLM Generation (ChatOpenAI)                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                                                    â”‚
â”‚            â–¼                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ verify_factual_claims_against_rag()                      â”‚  â”‚
â”‚  â”‚ â€¢ extract_factual_claims()                               â”‚  â”‚
â”‚  â”‚ â€¢ Check each claim in RAG context                        â”‚  â”‚
â”‚  â”‚ â€¢ Return verification results                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Logging Flow

```
Request: "When was King Library built?"
    â”‚
    â–¼
ğŸ§  [Meta Router] Classifying user intent
ğŸ¯ [Meta Router] Classified as: general_question
ğŸ“‹ [Meta Router] Selected agents: transcript_rag, google_site
    â”‚
    â–¼
âš¡ [Orchestrator] Executing 2 agent(s) in parallel
ğŸ”® [Transcript RAG Agent] Querying optimized knowledge base
    â”‚
    â–¼
âœ… [Orchestrator] All agents completed
ğŸ¤– [Synthesizer] Generating final answer
    â”‚
    â–¼
ğŸ”’ [Fact Grounding] Detected factual query types: date
ğŸ“Š [Fact Grounding] RAG confidence: High confidence match (similarity: 0.92)
ğŸ”’ [Fact Grounding] Using strict grounding mode
    â”‚
    â–¼
ğŸ” [Fact Verifier] Checking factual claims against RAG context
âœ… [Fact Verifier] All factual claims verified against RAG
    â”‚
    â–¼
ğŸ” [URL Validator] Checking URLs in response
    â”‚
    â–¼
Response: "King Library was built in 1972."
```

---

## Testing Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TESTING UTILITIES                                             â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚ update_rag_facts.py  â”‚                                      â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                                      â”‚
â”‚  â”‚ â€¢ Define CORRECT_    â”‚                                      â”‚
â”‚  â”‚   FACTS              â”‚                                      â”‚
â”‚  â”‚ â€¢ add_or_update_     â”‚                                      â”‚
â”‚  â”‚   fact()             â”‚â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ â€¢ verify_fact()      â”‚    â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                                 â”‚
â”‚                              â”‚                                 â”‚
â”‚                              â–¼                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                    â”‚  WEAVIATE DB     â”‚                        â”‚
â”‚                    â”‚  TranscriptQA    â”‚                        â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                              â”‚                                 â”‚
â”‚                              â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ query_rag.py         â”‚â—„â”€â”€â”€â”´â”€â”€â”€â–ºâ”‚ test_fact_queries.py    â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚          â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚ â€¢ Direct RAG query   â”‚          â”‚ â€¢ Test suite            â”‚ â”‚
â”‚  â”‚ â€¢ Show similarity    â”‚          â”‚ â€¢ Keyword verification  â”‚ â”‚
â”‚  â”‚ â€¢ Recommendations    â”‚          â”‚ â€¢ Pass/fail reporting   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Testing Workflow:
    1. update_rag_facts.py  â†’ Add facts to DB
    2. query_rag.py         â†’ Verify single fact
    3. test_fact_queries.py â†’ Run full test suite
    4. Manual chatbot test  â†’ End-to-end verification
```

---

**Architecture Version**: 2.3  
**Last Updated**: December 9, 2025  
**Developer**: Meng Qu, Miami University Libraries - Oxford, OH
